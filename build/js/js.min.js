
function isLeapYear(year){return new Date(year,1,29).getMonth()==1;}
function formatDateToString(date){return date.getDate()+"-"+getMonthName(date)+"-"+date.getFullYear()+" 00:00:00";}
function getUnixTime(time){return new Date(time).getTime()/1000;}
function getDateFromDay(day,year){var date=new Date(year,0);return new Date(date.setDate(day));}
function getMonthName(date){return date.toLocaleString("en-us",{month:"short"});}
function getStringFromDate(date){return date.getDate()+"."+(date.getMonth()+1)+"."+date.getFullYear();}
function resetTimeInDate(date){date.setMinutes(0);date.setSeconds(0);date.setHours(0);return date;}

document.addEventListener('DOMContentLoaded',function(){var el_days=get("days"),loader=get("loader"),input=get("input"),go_btn=get("go"),birth={day:get("birth-day"),month:get("birth-month"),year:get("birth-year")};var user_date={year:false,month:false,day:false,set:function(d,m,y){this.day=parseInt(d,10);this.month=parseInt(m,10);this.year=parseInt(y,10);},check:function(){return(this.year&&this.month&&this.day);},init:function(){this.date=new Date(this.year,this.month-1,this.day);this.date_sec=getUnixTime(formatDateToString(this.date));}};var now={date:resetTimeInDate(new Date()),init:function(){this.year=this.date.getFullYear();this.date_sec=getUnixTime(formatDateToString(this.date));}};now.init();if(user_date.check()){hideElement(input);setTimeout(function(){renderDays(el_days,now,user_date,function(){hideElement(loader);});},100);}
hideElement(loader);hideElement(get("alert"));hideElement(get("save"));go_btn.addEventListener("click",function(){go(user_date,birth,loader,input,el_days,now);});input.addEventListener("keypress",function(e){if(e.keyCode==13){go(user_date,birth,loader,input,el_days,now);}});get("save").addEventListener("click",function(){if(saver.save(user_date)){showAlert("Saved successfully")}else{showAlert("Can't save, please open an issue");}});});function go(user_date,birth,loader,input,el_days,now){if(validateInput(birth)){user_date.set(birth.day.value,birth.month.value,birth.year.value);user_date.init();showElement(loader);hideElement(input);setTimeout(function(){renderDays(el_days,now,user_date,function(){hideElement(loader);showElement(get("save"));addClass(get("alert"),"black");});},100);}}

function getDaysTillBirthday(user_date){var date=new Date(user_date.year,0,1);var date_sec=getUnixTime(formatDateToString(date));return-Math.floor((user_date.date_sec-date_sec)/(60*60*24));}

function renderDays(el,now,user_date,callback){var y,till,d,k,rows_amount,j,c,year,year_rows_wrap,half_year;c=getDaysTillBirthday(user_date);till=user_date.year+80;y=user_date.year;while(y<=now.year){if(isLeapYear(y)){d=366;}else{d=365;}
year=generateYear(y);year_rows_wrap=document.createElement('div');year_rows_wrap.setAttribute('class',"half-year-wrap");rows_amount=5;k=1;j=1;while(k<=rows_amount){half_year=document.createElement('div');half_year.setAttribute('class',"half-year");j=generateDays(user_date,now,j,Math.ceil(d*(k/rows_amount)),y,half_year,c);year_rows_wrap.appendChild(half_year);k++;}
c+=j-1;year.appendChild(year_rows_wrap);el.appendChild(year);y++;}
while(y<=till){if(isLeapYear(y)){d=366;}else{d=365;}
year=generateYear(y);year_rows_wrap=document.createElement('div');year_rows_wrap.setAttribute('class',"half-year-wrap");rows_amount=5;k=1;j=1;while(k<=rows_amount){half_year=document.createElement('div');half_year.setAttribute('class',"half-year");j=generateFutureDays(j,Math.ceil(d*(k/rows_amount)),y,half_year,c);year_rows_wrap.appendChild(half_year);k++;}
c+=j-1;year.appendChild(year_rows_wrap);el.appendChild(year);y++;}
if(typeof callback==="function"){callback();}}

function generateDay(toAppend,classes,data_day,data_date,title){var day=document.createElement('div');day.setAttribute('class','day '+classes);day.setAttribute('title',title);day.setAttribute('data-day',data_day);day.setAttribute('data-date',data_date);toAppend.appendChild(day);}

function generateDays(user_date,now,start,max,year,toAppend,days_counter){var day_class,day_title,this_date,this_day;while(start<=max){day_class='';this_date=getDateFromDay(start,year);this_day=getUnixTime(formatDateToString(this_date));if(user_date.date_sec<=this_day&&this_day<now.date_sec){day_class+=" ended";}
if(this_day==now.date_sec){day_class+=" current";}
if(this_day<user_date.date_sec){day_title="["+getStringFromDate(this_date)+"]";}else{day_title="["+getStringFromDate(this_date)+"] "+(days_counter+start)+" day of your life";}
generateDay(toAppend,day_class,start,this_date,day_title);start++;}
return start;}

function generateFutureDays(start,max,year,toAppend,days_counter){var day_class,day_title,this_date,this_day;while(start<=max){day_class='';this_date=getDateFromDay(start,year);this_day=getUnixTime(formatDateToString(this_date));day_title="["+getStringFromDate(this_date)+"] "+(days_counter+start)+" day of your life";generateDay(toAppend,day_class,start,this_date,day_title);start++;}
return start;}

function generateYear(year){var year_div=document.createElement('div');year_div.setAttribute('class',"year");var year_title=document.createElement('div');year_title.textContent=year;year_title.setAttribute('class',"year-title");year_div.appendChild(year_title);return year_div;}

function showAlert(message){var div=document.getElementById("alert");div.textContent=message;addClass(div,"animate-from-down");showElement(div);setTimeout(function(){hideElement(div);removeClass(div,"animate-from-down");},3000);}

function addClass(el,classname){el.classList.add(classname);}
function removeClass(el,classname){el.classList.remove(classname);}

function dumpStyles(){var crossrule;if(document.styleSheets[0].cssRules){crossrule=document.styleSheets[0].cssRules}else if(document.styleSheets[0].rules){crossrule=document.styleSheets[0].rules}
if(!crossrule){showAlert("Can't save css styles, please open an issue");return false;}
var i=0;var dump="";while(i<crossrule.length){dump+=crossrule[i].cssText;i++;}
return dump;}

function get(id){return document.getElementById(id);}

function l(str){console.log(str);}

var saver={html:{header:{open:'<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>My Life</title>',close:'</head><body><header><div class="title">My Life</div><div class="arrow">&darr; Years | Days &rarr;</div></header>'},footer:"</body></html>"},save:function(user_date){var html=this.html.header.open+
this.generate.js(user_date)+this.generate.css()+
this.html.header.close+
this.generate.body()+
this.html.footer;return download(html,"days.html","text/plain");},generate:{js:function(ud){return'<script>'+'function resetTimeInDate(e){return e.setMinutes(0),e.setSeconds(0),e.setHours(0),e}function getUnixTime(e,t){return t?Math.floor(new Date(e).getTime()/1e3):Math.floor(e.getTime()/1e3)}function getCurrent(e,t,n){for(var i,r=getUnixTime(resetTimeInDate(new Date(e,t-1,n))),a=getUnixTime(resetTimeInDate(new Date)),s=document.getElementsByClassName("day"),d=0;d<s.length;d++)i=getUnixTime(s[d].getAttribute("data-date"),!0),i>=r&&a>i&&(s[d].classList.remove("current"),s[d].classList.add("ended")),i===a&&s[d].classList.add("current")}'+'document.addEventListener("DOMContentLoaded",function(){'+'getCurrent('+ud.year+','+ud.month+','+ud.day+')});'+'</script>';},css:function(){return'<style>'+dumpStyles()+'</style>';},body:function(){return get("days-wrap").outerHTML;}}};

function validateInput(divs){var d=divs.day.value,m=divs.month.value,y=divs.year.value;if(!(d&&m&&y)){showAlert("Input is empty");return false;}
if(!(parseInt(d)&&parseInt(m)&&parseInt(y))){showAlert("Please, input a number");return false;}
if(y<1910){showAlert("Please, stop hacking this site");return false;}
if(d<=31&&m<=12){return true;}else{showAlert("Please, input a valid date");return false;}}

function showElement(el){removeClass(el,"none");}
function hideElement(el){addClass(el,"none");}